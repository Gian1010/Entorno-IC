version: 2.1

jobs:
  test:
    docker:
      - image: cimg/node:18.17.1
    steps:
      - checkout
      - run: npm install
      - run:
          name: Run Tests
          command: npm test
      - run:
          name: Notify Slack on Success
          when: on_success
          command: |
            curl -X POST -H 'Content-type: application/json' \
            --data '{"text":"âœ… Â¡Los tests pasaron con Ã©xito! ðŸŽ‰"}' \
            $SLACK_WEBHOOK_URL_GIAN
      - run:
          name: Notify Slack on Failure
          when: on_fail
          command: |
            curl -X POST -H 'Content-type: application/json' \
            --data '{"text":"âŒ *Fallo en los tests* en CircleCI ðŸš¨"}' \
            $SLACK_WEBHOOK_URL_GIAN
      - run:
          name: Send mail on tests success
          when: on_success
          command: |
            npm run sendmail -- "âœ… Tests exitosos" "Los tests automatizados pasaron correctamente en CircleCI. âœ…ðŸŽ‰"

      - run:
          name: Send mail on tests failure
          when: on_fail
          command: |
            npm run sendmail -- "âŒ Error en tests" "Al menos uno de los tests automatizados fallÃ³ en CircleCI. RevisiÃ³n necesaria. âŒðŸ§ª"


  sonarcloud:
    docker:
      - image: cimg/node:18.17.1
    steps:
      - checkout
      - run: npm install
      - run:
          name: Instalar jq y dependencias
          command: |
            sudo apt-get update
            sudo apt-get install -y jq openjdk-17-jre-headless
      - run:
          name: Ejecutar anÃ¡lisis SonarCloud
          command: npx sonar-scanner
      - run:
          name: Verificar estado del Quality Gate
          command: |
            sleep 15
            STATUS=$(curl -s -u $SONAR_TOKEN: "https://sonarcloud.io/api/qualitygates/project_status?projectKey=Gian1010_Entorno-IC" | jq -r '.projectStatus.status')
            if [ "$STATUS" != "OK" ]; then
              echo "âŒ Quality Gate fallÃ³: $STATUS"
              curl -X POST -H 'Content-type: application/json' \
              --data '{"text":"ðŸš¨ *El anÃ¡lisis de SonarCloud fallÃ³ el Quality Gate.* RevisÃ¡: https://sonarcloud.io/project/overview?id=Gian1010_Entorno-IC"}' \
              $SLACK_WEBHOOK_URL_GIAN
              exit 1
            else
              echo "âœ… Quality Gate pasÃ³ con Exito"
              curl -X POST -H 'Content-type: application/json' \
              --data '{"text":"âœ… *El cÃ³digo pasÃ³ el Quality Gate en SonarCloud.* Â¡Excelente trabajo Gianfranco! ðŸŽ‰ðŸŽ‰ðŸŽ‰\nðŸ”— https://sonarcloud.io/project/overview?id=Gian1010_Entorno-IC"}' \
              $SLACK_WEBHOOK_URL_GIAN
            fi
      - run:
          name: Send mail on SonarCloud success
          when: on_success
          command: |
            npm run sendmail -- "âœ… SonarCloud: Quality Gate aprobado" "El anÃ¡lisis de calidad de cÃ³digo en SonarCloud fue exitoso. El proyecto pasÃ³ el Quality Gate correctamente. ðŸ”— https://sonarcloud.io/project/overview?id=Gian1010_Entorno-IC"

      - run:
          name: Send mail on SonarCloud failure
          when: on_fail
          command: |
            npm run sendmail -- "âŒ SonarCloud: Quality Gate fallido" "El anÃ¡lisis de SonarCloud fallÃ³ el Quality Gate. Es necesario revisar el informe: ðŸ”— https://sonarcloud.io/project/overview?id=Gian1010_Entorno-IC"


  deploy_render:
    docker:
      - image: cimg/node:18.17.1
    steps:
      - checkout
      - run: npm install
      - run:
          name: Trigger Deploy on Render
          command: |
            curl -X POST $RENDER_DEPLOY_HOOK_URL
      - run:
          name: Notify Slack on Success (Deploy)
          when: on_success
          command: |
            curl -X POST -H 'Content-type: application/json' \
            --data '{
              "text": "âœ… *Deploy exitoso en Render!* ðŸŽ‰\n\n*Proyecto:* Entorno-IC\n*Branch:* '"$CIRCLE_BRANCH"'\n*Commit:* '"$CIRCLE_SHA1"'\n*Autor:* '"$CIRCLE_USERNAME"'\n\nðŸ”— https://entorno-ic-gian.onrender.com/"
            }' \
            $SLACK_WEBHOOK_URL_GIAN
      - run:
          name: Notify Slack on Failure (Deploy)
          when: on_fail
          command: |
            curl -X POST -H 'Content-type: application/json' \
            --data "{\"text\":\"âŒ *El deploy en Render fallÃ³.* ðŸš¨ Revisar en CircleCI: $CIRCLE_BUILD_URL\"}" \
            $SLACK_WEBHOOK_URL_GIAN
      - run:
          name: Send mail on Deploy success
          when: on_success
          command: |
            npm run sendmail -- "âœ… Deploy exitoso en Render" "El despliegue fue exitoso. ðŸŽ‰ Proyecto: Entorno-IC Branch: $CIRCLE_BRANCH Commit: $CIRCLE_SHA1 Autor: $CIRCLE_USERNAME ðŸ”— https://entorno-ic-gian.onrender.com/"

      - run:
          name: Send mail on Deploy Failure
          when: on_fail
          command: |
            npm run sendmail -- "âŒ Deploy fallido en Render" "El despliegue fallÃ³ en Render. ðŸš¨ Revisar en CircleCI: $CIRCLE_BUILD_URL"

move_card_trello:
  docker:
    - image: curlimages/curl:latest
  steps:
    - checkout
    - run:
        name: Validar coincidencia de commit y tarjeta
        command: |
          COMMIT_MSG=$(git log -1 --pretty=%s)
          echo "Ãšltimo commit: $COMMIT_MSG"

          CARD_NAME=$(curl -s "https://api.trello.com/1/cards/$TRELLO_CARD_ID?key=$TRELLO_KEY&token=$TRELLO_TOKEN" | jq -r '.name')
          echo "Nombre de la tarjeta: $CARD_NAME"

          if [ "$COMMIT_MSG" = "$CARD_NAME" ]; then
            echo "âœ… Coinciden. Moviendo tarjeta y marcando como completada..."

            curl -X PUT "https://api.trello.com/1/cards/${TRELLO_CARD_ID}?idList=${TRELLO_LIST_ID_DONE}&key=${TRELLO_KEY}&token=${TRELLO_TOKEN}"
            curl -X PUT "https://api.trello.com/1/cards/$TRELLO_CARD_ID?key=$TRELLO_KEY&token=$TRELLO_TOKEN" \
              -d "dueComplete=true"
          else
            echo "â›” No coinciden. No se realiza ninguna acciÃ³n en Trello."
          fi

workflows:
  version: 2
  test_analyze_and_deploy:
    jobs:
      - test
      - sonarcloud:
          requires:
            - test
      - deploy_render:
          requires:
            - sonarcloud
      - move_card_trello:
          requires:
            - deploy_render





#Usa una imagen de Docker con Node.js 18.17.1.
#Clona tu cÃ³digo (checkout).
#Ejecuta npm install para instalar dependencias.
#Ejecuta npm test para correr tus pruebas con Mocha. error de test -> era por node_modules en el repo lo arregle con gitignore