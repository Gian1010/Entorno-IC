version: 2.1

jobs:
  test:
    docker:
      - image: cimg/node:18.17.1
    steps:
      - checkout
      - run: npm install
      - run:
          name: Run Tests
          command: npm test
      - run:
          name: Notify Slack on Success
          when: on_success
          command: |
            curl -X POST -H 'Content-type: application/json' \
            --data '{"text":"âœ… Â¡Los tests pasaron con Ã©xito! ðŸŽ‰"}' \
            $SLACK_WEBHOOK_URL_GIAN
      - run:
          name: Notify Slack on Failure
          when: on_fail
          command: |
            curl -X POST -H 'Content-type: application/json' \
            --data '{"text":"âŒ *Fallo en los tests* en CircleCI ðŸš¨"}' \
            $SLACK_WEBHOOK_URL_GIAN

  sonarcloud:
    docker:
      - image: cimg/node:18.17.1
    steps:
      - checkout
      - run:
          name: Instalar jq y dependencias
          command: |
            sudo apt-get update
            sudo apt-get install -y jq openjdk-17-jre-headless
      - run:
          name: Instalar sonar-scanner
          command: npm install -g sonar-scanner
      - run:
          name: Ejecutar anÃ¡lisis SonarCloud
          command: sonar-scanner
      - run:
          name: Verificar estado del Quality Gate
          command: |
            sleep 15
            STATUS=$(curl -s -u $SONAR_TOKEN: "https://sonarcloud.io/api/qualitygates/project_status?projectKey=Gian1010_Entorno-IC" | jq -r '.projectStatus.status')
            if [ "$STATUS" != "OK" ]; then
              echo "âŒ Quality Gate fallÃ³: $STATUS"
              curl -X POST -H 'Content-type: application/json' \
              --data '{"text":"ðŸš¨ *El anÃ¡lisis de SonarCloud fallÃ³ el Quality Gate.* RevisÃ¡: https://sonarcloud.io/project/overview?id=Gian1010_Entorno-IC"}' \
              $SLACK_WEBHOOK_URL_GIAN
              exit 1
            else
              echo "âœ… Quality Gate pasÃ³"
              curl -X POST -H 'Content-type: application/json' \
              --data '{"text":"âœ… *El cÃ³digo pasÃ³ el Quality Gate en SonarCloud.* Â¡Buen trabajo! ðŸŽ‰\nðŸ”— https://sonarcloud.io/project/overview?id=Gian1010_Entorno-IC"}' \
              $SLACK_WEBHOOK_URL_GIAN
            fi

workflows:
  version: 2
  test_and_analyze:
    jobs:
      - test
      - sonarcloud:
          requires:
            - test



#Usa una imagen de Docker con Node.js 18.17.1.
#Clona tu cÃ³digo (checkout).
#Ejecuta npm install para instalar dependencias.
#Ejecuta npm test para correr tus pruebas con Mocha. error de test -> era por node_modules en el repo lo arregle con gitignore